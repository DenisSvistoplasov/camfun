<!DOCTYPE html>
<html>
<head>
<title>CamFun 2.0.0</title>
<meta name="generator" content="Bluefish 2.2.7" >
<meta name="author" content="Anton Yun" >
<meta name="date" content="2017-09-02T03:04:27+0900" >
<meta name="copyright" content="">
<meta name="keywords" content="">
<meta name="description" content="">
<meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<meta http-equiv="expires" content="0">
<style type="text/css">
	span {
		color: #F38383;
	}
	label {
		cursor: default;
	}
	table {
		margin: 25px;
		border-collapse: collapse;
		border: thin #EEEEEE solid;
		border-bottom: thick #CCFFFF solid;
	}
</style>
</head>
<body>
<h1>Peer-To-Peer video chat CamFun 2.0.0</h1>
<p>Your peer ID is: <span id="peer-id"></span></p>
<form id="form">
<label for="remote-id">Connect to a peer:</label>
<input type="text" name="remote-id" id="remote-id" placeholder="Someone else's peer ID" />
<input type="button" name="call" id="call" value="Call" />
<input type="button" name="hangup" id="hangup" value="Hang Up" />
</form>
<table>
	<thead>
		<tr>
			<td>Local Stream</td>
			<td>Remote Stream</td>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><video id="localVideo" autoplay></video></td>
			<td><video id="remoteVideo" autoplay></video></td>
		</tr>
	</tbody>
</table>
<script type="text/javascript">
	var localId, remoteId;
	var localStream;
	var configuration = {"iceServers":[{"urls":"stun:stun.l.google.com:19302"},{"urls":"turn:luckydrawhk.com:3478","credential":"pfhMZ5eDFu4Er5xf","username":"lovely"}]};
	var localPeerConnection;

	document.getElementById("remote-id").disabled = false;
	document.getElementById("call").disabled = false;
	document.getElementById("hangup").disabled = true;

	socket = new WebSocket('ws://172.17.0.2');

	navigator.mediaDevices.getUserMedia({audio:true, video:true}).then(function(stream) {
		localVideo.srcObject = stream;
		localStream = stream;
	}).catch(function(error) {
		log("navigator.getUserMedia error: ", error);
	});

	document.getElementById("call").addEventListener("click", function(event) {
		event.preventDefault();
		remoteId = document.getElementById("remote-id").value;
		localPeerConnection = new RTCPeerConnection(configuration);
		localPeerConnection.onicecandidate = function(event){
			if (!localPeerConnection || !event || !event.candidate) return;
			var candidate = event.candidate;
			var message = JSON.stringify({ "to" : remoteId, "from" : localId, "type" : "candidate", "iceCandidate" : candidate });
			socket.send(message);
		};
		localPeerConnection.ontrack = function (event) {
			remoteVideo.srcObject = event.streams[0];
		};
		localPeerConnection.addStream(localStream);
		localPeerConnection.createOffer(function(offer) {
			localPeerConnection.setLocalDescription(new RTCSessionDescription(offer), function() {
				var message = JSON.stringify({ "to" : remoteId, "from" : localId, "type" : "offer", "SessionDescription" : offer });
				socket.send(message);
			}, function(handleGetUserMediaError){
				console.log('Failed to create signaling message : ' + handleGetUserMediaError.name);
			});
		}, function(handleGetUserMediaError){
			console.log('Failed to create signaling message : ' + handleGetUserMediaError.name);
		});
	}, false);

	document.getElementById("hangup").addEventListener("click", function(event) {
		event.preventDefault();
		var message = JSON.stringify({ "to" : remoteId, "from" : localId, "type" : "hangup" });
		socket.send(message);
		localPeerConnection.close();
		localPeerConnection = null;
		document.getElementById("remote-id").disabled = false;
		document.getElementById("call").disabled = false;
		document.getElementById("hangup").disabled = true;
	});

	socket.onmessage = function(event) {
		var data = JSON.parse(event.data);
		switch(data.type) {
			case "id":
				localId = data.id;
				document.getElementById("peer-id").innerHTML = localId;
				break;
			case "candidate":
				localPeerConnection.addIceCandidate(new RTCIceCandidate(data.iceCandidate));
				break;
			case "offer":
				remoteId = data.from;
				document.getElementById("remote-id").value = remoteId;
				document.getElementById("remote-id").disabled = true;
				document.getElementById("call").disabled = true;
				document.getElementById("hangup").disabled = false;
				localPeerConnection = new RTCPeerConnection(configuration);
				localPeerConnection.onicecandidate = function(event){
					if (!localPeerConnection || !event || !event.candidate) return;
					var candidate = event.candidate;
					var message = JSON.stringify({ "to" : remoteId, "from" : localId, "type" : "candidate", "iceCandidate" : candidate });
					socket.send(message);
				};
				localPeerConnection.ontrack = function (event) {
					remoteVideo.srcObject = event.streams[0];
				};
				localPeerConnection.addStream(localStream);
				localPeerConnection.setRemoteDescription(new RTCSessionDescription(data.SessionDescription)).then(function (){
					localPeerConnection.createAnswer(function(answer) {
						localPeerConnection.setLocalDescription(new RTCSessionDescription(answer), function() {
							var message = JSON.stringify({ "to" : remoteId, "from" : localId, "type" : "answer", "SessionDescription" : answer });
							socket.send(message);
						}, function(handleGetUserMediaError){
							console.log('Failed to create signaling message : ' + handleGetUserMediaError.name);
						});
					}, function(handleGetUserMediaError){
						console.log('Failed to create signaling message : ' + handleGetUserMediaError.name);
					});
				});
				break;
			case "answer":
				document.getElementById("remote-id").disabled = true;
				document.getElementById("call").disabled = true;
				document.getElementById("hangup").disabled = false;
				localPeerConnection.setRemoteDescription(new RTCSessionDescription(data.SessionDescription));
				break;
			case "hangup":
				localPeerConnection.close();
				localPeerConnection = null;
				document.getElementById("remote-id").disabled = false;
				document.getElementById("call").disabled = false;
				document.getElementById("hangup").disabled = true;
				break;
			case "error":
				localPeerConnection = null;
				document.getElementById("remote-id").disabled = false;
				document.getElementById("call").disabled = false;
				document.getElementById("hangup").disabled = true;
				console.log(data.error);
				break;
		}
	};
</script>
</body>
</html>
