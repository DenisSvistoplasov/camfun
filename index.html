<!DOCTYPE html>
<html>
<head>
<title>WebSocket</title>
<meta name="generator" content="Bluefish 2.2.7" >
<meta name="author" content="Anton Yun" >
<meta name="date" content="2017-08-31T23:10:04+0900" >
<meta name="copyright" content="">
<meta name="keywords" content="">
<meta name="description" content="">
<meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<meta http-equiv="expires" content="0">
<style type="text/css">
	span {
		color: #F38383;
	}
	label {
		cursor: default;
	}
	table {
		margin: 25px;
		border-collapse: collapse;
		border: thin #EEEEEE solid;
		border-bottom: thick #CCFFFF solid;
	}
</style>
</head>
<body>
<h1>Peer-To-Peer video chat CamFun 2.0.0</h1>
<p>Your peer ID is: <span id="peer-id"></span></p>
<form id="form">
<label for="remote-id">Connect to a peer:</label>
<input type="text" name="remote-id" id="remote-id" placeholder="Someone else's peer ID" />
<input type="submit" />
</form>
<table>
	<thead>
		<tr>
			<td>Local Stream</td>
			<td>Remote Stream</td>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><video id="localVideo" autoplay></video></td>
			<td><video id="remoteVideo" autoplay></video></td>
		</tr>
	</tbody>
</table>
<script type="text/javascript">
	var localStream, localPeerConnection;

	var configuration = {"iceServers":[{"urls":"stun:stun.l.google.com:19302"},{"urls":"turn:luckydrawhk.com:3478","credential":"pfhMZ5eDFu4Er5xf","username":"lovely"}]};

	socket = new WebSocket('ws://172.17.0.4');

	navigator.mediaDevices.getUserMedia({audio:true, video:true}).then(function(stream) {
		localVideo.srcObject = stream;
		localStream = stream;
	}).catch(function(error) {
		log("navigator.getUserMedia error: ", error);
	});

	document.getElementById("form").addEventListener("submit", function(event){
		event.preventDefault();
		socket.send(document.getElementById("remote-id").value);
		// document.getElementById("form").style.display = 'none';
		localPeerConnection = new RTCPeerConnection(configuration);
		localPeerConnection.onicecandidate = function(event){
			if (!event || !event.candidate) return;
			console.log(JSON.stringify(event.candidate));
			socket.send(JSON.stringify(event.candidate));
		};
		localPeerConnection.ontrack = function (event) {
			remoteVideo.srcObject = event.streams[0];
		};
		localPeerConnection.addStream(localStream);
		
		localPeerConnection.createOffer(function(offer) {
			localPeerConnection.setLocalDescription(new RTCSessionDescription(offer), function() {
				console.log(JSON.stringify(offer));
				socket.send(JSON.stringify(offer));
			}, function(handleGetUserMediaError){
				console.log('Failed to create signaling message : ' + handleGetUserMediaError.name);
			});
		}, function(handleGetUserMediaError){
			console.log('Failed to create signaling message : ' + handleGetUserMediaError.name);
		});
	}, false);

	socket.onmessage = function(event) {
		document.getElementById("peer-id").innerHTML = event.data;
	};
</script>
</body>
</html>
